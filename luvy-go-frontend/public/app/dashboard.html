<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard | LUVY</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="api.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg-primary:#0f1419;
  --bg-secondary:#1a1f2e;
  --bg-tertiary:#252b3b;
  --text-primary:#ffffff;
  --text-secondary:#b4bcd0;
  --text-tertiary:#8b93a7;
  --accent-purple:#8b5cf6;
  --accent-blue:#3b82f6;
  --accent-green:#10b981;
  --accent-red:#ef4444;
  --border:#2d3748;
  --radius:8px;
  --radius-lg:12px;
}
body{
  font-family:'Inter',-apple-system,sans-serif;
  background:var(--bg-primary);
  color:var(--text-primary);
  -webkit-font-smoothing:antialiased;
}

/* Header */
header{
  background:var(--bg-secondary);
  border-bottom:1px solid var(--border);
  position:sticky;
  top:0;
  z-index:100;
}
.header-inner{
  max-width:1440px;
  margin:0 auto;
  padding:0 24px;
  height:60px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.logo{
  display:flex;
  align-items:center;
  gap:10px;
  text-decoration:none;
}
.logo-mark{
  width:32px;
  height:32px;
  border-radius:var(--radius);
  background:linear-gradient(135deg,var(--accent-purple),var(--accent-blue));
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-weight:700;
  font-size:16px;
}
.logo-text{
  font-size:16px;
  font-weight:700;
  color:var(--text-primary);
}
.nav{
  display:flex;
  gap:4px;
}
.nav-link{
  padding:8px 16px;
  border-radius:var(--radius);
  text-decoration:none;
  color:var(--text-secondary);
  font-size:14px;
  font-weight:500;
  transition:.15s;
}
.nav-link:hover{
  background:var(--bg-tertiary);
  color:var(--text-primary);
}
.nav-link.active{
  background:var(--accent-purple);
  color:#fff;
}
.balance{
  display:flex;
  align-items:center;
  gap:12px;
  padding:8px 16px;
  background:var(--bg-tertiary);
  border-radius:var(--radius);
}
.balance-value{
  font-size:16px;
  font-weight:700;
  color:var(--accent-purple);
}

/* Main */
main{
  max-width:1440px;
  margin:0 auto;
  padding:24px;
}

/* Welcome Section */
.welcome{
  background:linear-gradient(135deg,rgba(139,92,246,.1),rgba(59,130,246,.1));
  border:1px solid rgba(139,92,246,.2);
  border-radius:var(--radius-lg);
  padding:32px;
  margin-bottom:24px;
}
.welcome h1{
  font-size:32px;
  font-weight:800;
  margin-bottom:8px;
}
.welcome p{
  font-size:16px;
  color:var(--text-secondary);
}

/* Stats Grid */
.stats-grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:20px;
  margin-bottom:24px;
}
.stat-card{
  background:var(--bg-secondary);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:24px;
}
.stat-icon{
  font-size:32px;
  margin-bottom:12px;
}
.stat-value{
  font-size:28px;
  font-weight:800;
  margin-bottom:4px;
  color:var(--text-primary);
}
.stat-label{
  font-size:13px;
  color:var(--text-tertiary);
  text-transform:uppercase;
  letter-spacing:.05em;
}

/* Recent Activity */
.activity-card{
  background:var(--bg-secondary);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:24px;
}
.activity-header{
  font-size:18px;
  font-weight:700;
  margin-bottom:20px;
  color:var(--text-primary);
}
.activity-list{
  display:flex;
  flex-direction:column;
  gap:12px;
}
.activity-item{
  display:flex;
  align-items:center;
  gap:12px;
  padding:16px;
  background:var(--bg-tertiary);
  border-radius:var(--radius);
  transition:.15s;
}
.activity-item:hover{
  background:rgba(139,92,246,.1);
}
.activity-icon{
  width:48px;
  height:48px;
  border-radius:50%;
  background:var(--bg-primary);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:24px;
}
.activity-details{
  flex:1;
}
.activity-merchant{
  font-size:15px;
  font-weight:600;
  margin-bottom:4px;
  color:var(--text-primary);
}
.activity-time{
  font-size:13px;
  color:var(--text-tertiary);
}
.activity-amount{
  font-size:16px;
  font-weight:700;
  color:var(--accent-green);
}

/* Loading & Empty States */
.loading{
  text-align:center;
  padding:40px;
  color:var(--text-tertiary);
}
.empty{
  text-align:center;
  padding:60px;
  color:var(--text-tertiary);
}
.empty-icon{
  font-size:48px;
  margin-bottom:16px;
}

/* Error */
.error-banner{
  background:rgba(239,68,68,.1);
  border:1px solid var(--accent-red);
  color:var(--accent-red);
  padding:16px 24px;
  border-radius:var(--radius-lg);
  margin-bottom:24px;
  display:flex;
  align-items:center;
  gap:12px;
}
.error-icon{
  font-size:24px;
}

@media(max-width:1200px){
  .stats-grid{
    grid-template-columns:repeat(2,1fr);
  }
}
@media(max-width:768px){
  .stats-grid{
    grid-template-columns:1fr;
  }
  .nav{
    display:none;
  }
}
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <a href="dashboard.html" class="logo">
      <div class="logo-mark">L</div>
      <span class="logo-text">LUVY</span>
    </a>
    <nav class="nav">
      <a href="dashboard.html" class="nav-link active">Dashboard</a>
      <a href="transactions.html" class="nav-link">Transactions</a>
      <a href="upload-receipt.html" class="nav-link">Upload</a>
      <a href="analytics.html" class="nav-link">Analytics</a>
      <a href="settings.html" class="nav-link">Settings</a>
    </nav>
    <div class="balance">
      <span>üíé</span>
      <span class="balance-value" id="balance">Loading...</span>
    </div>
  </div>
</header>

<main>
  <!-- Error Banner (hidden by default) -->
  <div id="errorBanner" style="display:none" class="error-banner">
    <span class="error-icon">‚ö†Ô∏è</span>
    <span id="errorMessage"></span>
  </div>

  <!-- Welcome -->
  <div class="welcome">
    <h1>Welcome back, <span id="userName">User</span>! üëã</h1>
    <p>Here's your LUVY overview</p>
  </div>

  <!-- Stats Grid -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">üí∞</div>
      <div class="stat-value" id="statBalance">-</div>
      <div class="stat-label">Balance</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üìÑ</div>
      <div class="stat-value" id="statReceipts">-</div>
      <div class="stat-label">Receipts</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üíé</div>
      <div class="stat-value" id="statEarned">-</div>
      <div class="stat-label">Earned</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üìà</div>
      <div class="stat-value" id="statMonth">-</div>
      <div class="stat-label">This Month</div>
    </div>
  </div>

  <!-- Recent Activity -->
  <div class="activity-card">
    <h2 class="activity-header">Recent Activity</h2>
    <div class="activity-list" id="activityList">
      <div class="loading">Loading activity...</div>
    </div>
  </div>
</main>

<script>
// ==========================================
// CHECK LOGIN
// ==========================================
if (!isLoggedIn()) {
  window.location.href = '/login.html';
}

// ==========================================
// LOAD DASHBOARD DATA
// ==========================================
async function loadDashboard() {
  try {
    // 1. Load user info
    const userStr = localStorage.getItem('user');
    if (userStr) {
      const user = JSON.parse(userStr);
      document.getElementById('userName').textContent = user.name || 'User';
    }

    // 2. Load balance
    const balanceData = await API.getBalance();
    const balance = balanceData.balance || 0;
    document.getElementById('balance').textContent = balance.toFixed(2) + ' LUVY';
    document.getElementById('statBalance').textContent = balance.toFixed(2);

    // 3. Load analytics overview
    const overview = await API.getAnalyticsOverview();
    document.getElementById('statReceipts').textContent = overview.total_receipts || 0;
    document.getElementById('statEarned').textContent = (overview.total_earned || 0).toFixed(2);
    document.getElementById('statMonth').textContent = (overview.this_month || 0).toFixed(2);

    // 4. Load recent receipts
    const receiptsData = await API.getReceipts();
    displayActivity(receiptsData.receipts || []);

  } catch (error) {
    console.error('Failed to load dashboard:', error);
    showError('Failed to load dashboard data. Please refresh the page.');
  }
}

// ==========================================
// DISPLAY ACTIVITY
// ==========================================
function displayActivity(receipts) {
  const container = document.getElementById('activityList');
  
  if (!receipts || receipts.length === 0) {
    container.innerHTML = `
      <div class="empty">
        <div class="empty-icon">üìÑ</div>
        <div>No activity yet</div>
        <div style="margin-top:12px">
          <a href="upload-receipt.html" style="color:var(--accent-purple);text-decoration:none;font-weight:600">
            Upload your first receipt ‚Üí
          </a>
        </div>
      </div>
    `;
    return;
  }

  // Show last 5 receipts
  const recent = receipts.slice(0, 5);
  
  container.innerHTML = recent.map(receipt => {
    const icon = getCategoryIcon(receipt.category);
    const time = formatTime(receipt.created_at);
    
    return `
      <div class="activity-item">
        <div class="activity-icon">${icon}</div>
        <div class="activity-details">
          <div class="activity-merchant">${receipt.merchant}</div>
          <div class="activity-time">${time} ‚Ä¢ ‚Ç¨${receipt.amount.toFixed(2)}</div>
        </div>
        <div class="activity-amount">+${receipt.tokens_earned.toFixed(2)}</div>
      </div>
    `;
  }).join('');
}

// ==========================================
// HELPERS
// ==========================================
function getCategoryIcon(category) {
  const icons = {
    grocery: 'üõí',
    electronics: 'üì±',
    healthcare: 'üíä',
    gas: '‚õΩ',
    clothing: 'üëî',
    restaurant: 'üçΩÔ∏è'
  };
  return icons[category] || 'üìÑ';
}

function formatTime(dateString) {
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  
  return date.toLocaleDateString('de-DE', {
    day: '2-digit',
    month: 'short'
  });
}

function showError(message) {
  const banner = document.getElementById('errorBanner');
  const messageEl = document.getElementById('errorMessage');
  messageEl.textContent = message;
  banner.style.display = 'flex';
}

// ==========================================
// INIT
// ==========================================
window.addEventListener('DOMContentLoaded', loadDashboard);
</script>
</body>
</html>
